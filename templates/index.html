<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>An Giang Trip Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body>
    <div class="app-shell">
        <div class="app-card">
            <header class="app-header">
                <div class="avatar"><img src="{{ url_for('static', filename='images/avatar.jpg') }}" /></div>
                <div class="header-text">
                    <div class="header-title">An Giang Trip Assistant</div>
                    <div class="header-subtitle">
                        Đặt chỗ, xem chuyến, hỏi đáp chỉ trong vài tin nhắn.
                    </div>
                </div>
                <div class="status-pill" id="status-pill">
                    <div class="status-dot"></div>
                    <span id="status-text">Sẵn sàng</span>
                </div>
            </header>

            <main class="chat-body">
                <div class="chat-log" id="chat-log"></div>

                <footer class="chat-footer">
                    <div class="input-row">
                        <textarea id="message-input" class="input-box"
                            placeholder="Nhập câu trả lời của bạn ở đây..."></textarea>
                        <button id="send-btn" class="btn btn-primary btn-icon" aria-label="Gửi">
                            <svg viewBox="0 0 24 24" class="icon-send" aria-hidden="true">
                                <path d="M4 4l16 8-16 8 4-8-4-8z" fill="currentColor" />
                            </svg>
                        </button>
                        <button id="new-btn" class="btn btn-ghost btn-icon btn-new"
                            aria-label="Bắt đầu cuộc trò chuyện mới">
                            <span class="plus-icon">+</span>
                        </button>

                    </div>
                    <div class="hint-row">
                        <span>Enter để gửi · Shift+Enter để xuống dòng</span>
                        <span><code>Chat demo An Giang Trip</code></span>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <script>
        const chatLog = document.getElementById("chat-log");
        const messageInput = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-btn");
        const newBtn = document.getElementById("new-btn");
        const statusText = document.getElementById("status-text");

        function addMessage(sender, text, senderType) {
            const row = document.createElement("div");
            row.classList.add("message-row", senderType);

            const bubble = document.createElement("div");
            bubble.classList.add("bubble", senderType);

            const senderLabel = document.createElement("div");
            senderLabel.classList.add("bubble-sender");
            senderLabel.textContent = sender;

            const content = document.createElement("div");
            content.textContent = text;

            const timeLabel = document.createElement("div");
            timeLabel.classList.add("bubble-time");
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, "0");
            const mm = String(now.getMinutes()).padStart(2, "0");
            timeLabel.textContent = `${hh}:${mm}`;

            bubble.appendChild(senderLabel);
            bubble.appendChild(content);
            bubble.appendChild(timeLabel);

            row.appendChild(bubble);
            chatLog.appendChild(row);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        async function startConversation() {
            statusText.textContent = "Đang tải...";
            try {
                const res = await fetch("/start");
                const data = await res.json();
                chatLog.innerHTML = "";
                if (data.bot) {
                    addMessage("An Giang Trip Bot", data.bot, "bot");
                }
                statusText.textContent = "Đang trò chuyện";
            } catch (e) {
                console.error(e);
                statusText.textContent = "Lỗi kết nối";
                addMessage("Hệ thống", "Không thể khởi tạo cuộc trò chuyện.", "bot");
            }
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            addMessage("Bạn", text, "user");
            messageInput.value = "";
            messageInput.focus();
            statusText.textContent = "Đang xử lý...";

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();
                if (data.bot) {
                    addMessage("An Giang Trip Bot", data.bot, "bot");
                }
                statusText.textContent = data.done ? "Hội thoại kết thúc" : "Đang trò chuyện";
            } catch (e) {
                console.error(e);
                addMessage("Hệ thống", "Có lỗi xảy ra khi xử lý. Hãy thử lại.", "bot");
                statusText.textContent = "Lỗi kết nối";
            }
        }

        sendBtn.addEventListener("click", sendMessage);
        newBtn.addEventListener("click", startConversation);

        messageInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Khởi động lần đầu
        startConversation();
    </script>
</body>

</html>